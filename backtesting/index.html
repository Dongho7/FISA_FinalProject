<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ë°±í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 2em; 
            background-color: #f9f9f9; 
        }
        h1, h2 { color: #333; }
        /* â­ï¸ [ì‹ ê·œ] ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .chart-container {
            max-width: 1000px; 
            background-color: #fff; 
            padding: 1em; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 2em; /* ì°¨íŠ¸ ê°„ ê°„ê²© */
        }
        #stats-container { 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
        }
        .stats-box { 
            flex: 1; 
            min-width: 200px; 
            background-color: #fff; 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .stats-box h2, .stats-box h3 { 
            margin-top: 0; 
            color: royalblue; 
        }
        .stats-box h2 { color: #555; }
        .kpi { 
            font-size: 1.4em; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #111; 
        }
        .label { 
            font-size: 0.9em; 
            color: #666; 
        }
        .mdd-kpi { color: #d9001b; }
        
        #ai-analysis-section { margin-top: 2em; }
        #analyzeButton { background-color: royalblue; color: white; border: none; padding: 12px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        #analyzeButton:hover { background-color: #3a5db0; }
        #analyzeButton:disabled { background-color: #ccc; cursor: not-allowed; }
        #ai-response-box { display: none; margin-top: 15px; background-color: #fff; border: 1px solid #ddd; border-left: 5px solid royalblue; padding: 1.5em; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #ai-response { white-space: pre-wrap; font-family: inherit; font-size: 1.05em; line-height: 1.6; color: #333; }
        .typing::after { content: 'â–‹ Woori-RisK_AI ë¶„ì„ ì¤‘'; animation: blink 1s step-end infinite; color: royalblue; }
        @keyframes blink { 50% { opacity: 0; } }
        
        /* â­ï¸ [ì‚­ì œ] í•˜ë½ì¥ ë°” ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ (ë” ì´ìƒ í•„ìš” ì—†ìŒ) */
        /* #crash-charts-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            max-width: 1024px;
        } 
        */

    </style>
</head>
<body>

    <h1>ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ì›”ê°„ ë¦¬ë°¸ëŸ°ì‹± ë°±í…ŒìŠ¤íŠ¸</h1>
    <p id="period-text">ë°ì´í„° ë¡œë”© ì¤‘...</p>
    
    <div id="stats-container">
        <div class="stats-box">
            <h3>ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤ (6:3:1)</h3>
            <div id="stats-portfolio">
                <div class="kpi" id="pf-value">-</div><div class="label">ìµœì¢… ìì‚°</div>
                <div class="kpi" id="pf-cagr" style="margin-top: 10px;">-</div><div class="label">ì—°í‰ê·  ìˆ˜ìµë¥  (CAGR)</div>
                <div class="kpi mdd-kpi" id="pf-mdd" style="margin-top: 10px;">-</div><div class="label">ìµœëŒ€ ì†ì‹¤í­ (MDD)</div>
            </div>
        </div>
        <div class="stats-box">
            <h2>KOSPI (ë²¤ì¹˜ë§ˆí¬)</h2>
            <div id="stats-benchmark">
                <div class="kpi" id="bm-value">-</div><div class="label">ìµœì¢… ìì‚°</div>
                <div class="kpi" id="bm-cagr" style="margin-top: 10px;">-</div><div class="label">ì—°í‰ê·  ìˆ˜ìµë¥  (CAGR)</div>
                <div class="kpi mdd-kpi" id="bm-mdd" style="margin-top: 10px;">-</div><div class="label">ìµœëŒ€ ì†ì‹¤í­ (MDD)</div>
            </div>
        </div>
    </div>
    
    <hr style="border: 0; border-top: 1px solid #eee; margin: 2em 0;">
    
    <h2>ëˆ„ì  ìˆ˜ìµë¥  (ì „ì²´ ê¸°ê°„)</h2>
    <div id="chart-container" class="chart-container">
        <canvas id="backtestChart"></canvas>
    </div>

    <div id="crash-analysis-section">
        <h2>ğŸ“‰ ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” ê¸‰ë½ì¥ì„ ì˜ ë²„í‹¸ ìˆ˜ ìˆì„ê¹Œ?</h2>
        
        <select id="crash-period-select" style="margin-bottom: 1em; padding: 8px; font-size: 1em; border-radius: 5px;">
            </select>
        
        <div id="crash-chart-box" class="stats-box" style="max-width: 600px; margin: 0;">
            <canvas id="singleCrashChartCanvas"></canvas> </div>
    </div>
    <div id="ai-analysis-section">
        <h2>ğŸ¤– AI ìë™ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
        <button id="analyzeButton" disabled>ê²°ê³¼ ë¡œë”© ì¤‘...</button>
        <div id="ai-response-box">
            <pre id="ai-response"></pre>
        </div>
    </div>

    <script>
        let evtSource = null;
        const aiButton = document.getElementById('analyzeButton');
        const aiBox = document.getElementById('ai-response-box');
        const aiResponseArea = document.getElementById('ai-response');
        
        // â­ï¸ [ì‹ ê·œ] ë‹¨ì¼ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ì™€ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let singleCrashChartInstance = null;
        let allCrashPeriodData = []; // ë°±ì—”ë“œì—ì„œ ë°›ì€ í•˜ë½ì¥ ë°ì´í„° ì›ë³¸

        document.addEventListener('DOMContentLoaded', () => {
            // 1. /api/backtest í˜¸ì¶œ (ëª¨ë“  ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ)
            fetch('http://127.0.0.1:5000/api/backtest')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    // 2. í†µê³„, ë¼ì¸ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ì´ì „ê³¼ ë™ì¼)
                    updateStats(data.stats, data.portfolio_history); 
                    renderChart(data.portfolio_history, data.benchmark_history);
                    
                    // â­ï¸ [ìˆ˜ì •]
                    // (1) ë°›ì€ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    allCrashPeriodData = data.crash_period_results;
                    
                    // (2) ë“œë¡­ë‹¤ìš´ ì„¤ì •
                    setupCrashDropdown(allCrashPeriodData);
                    
                    // (3) ì²« ë²ˆì§¸ í•˜ë½ì¥ ë°ì´í„°ë¡œ ì°¨íŠ¸ ì´ˆê¸° ë Œë”ë§
                    if (allCrashPeriodData && allCrashPeriodData.length > 0) {
                        renderSingleCrashChart(allCrashPeriodData[0]);
                    } else {
                        // â­ï¸ ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ìº”ë²„ìŠ¤ ìˆ¨ê¸°ê¸° ë“± ì˜ˆì™¸ ì²˜ë¦¬
                        document.getElementById('crash-chart-box').style.display = 'none';
                        console.warn("í•˜ë½ì¥ ë¶„ì„ ë°ì´í„°(crash_period_results)ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    }

                    // 3. AI ë¶„ì„ ë²„íŠ¼ í™œì„±í™” (ì´ì „ê³¼ ë™ì¼)
                    aiButton.disabled = false;
                    aiButton.textContent = "ğŸ¤– AIë¡œ ê²°ê³¼ ë¶„ì„í•˜ê¸°";
                })
                .catch(error => {
                    // 4. ì˜¤ë¥˜ ë°œìƒ ì‹œ
                    console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                    const container = document.getElementById('stats-container');
                    if (container) {
                        container.innerHTML = `<h2>âŒ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨</h2><p style="color: red;">ì„œë²„(app.py)ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆê±°ë‚˜ CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><p>ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message || error}</p>`;
                    }
                    aiButton.disabled = true;
                });
        });

        // 5. AI ë¶„ì„ ë²„íŠ¼ í´ë¦­ (SSE ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘)
        aiButton.addEventListener('click', () => {
            if (evtSource) { evtSource.close(); }
            aiButton.disabled = true;
            aiButton.textContent = "AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
            aiBox.style.display = 'block';
            aiResponseArea.innerHTML = ""; 
            aiResponseArea.classList.add("typing"); 

            evtSource = new EventSource('http://127.0.0.1:5000/api/analyze_stream');

            evtSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.event === 'done') {
                    evtSource.close(); 
                    evtSource = null;
                    aiButton.disabled = false;
                    aiButton.textContent = "âœ… ë¶„ì„ ì™„ë£Œ (ë‹¤ì‹œ ë¶„ì„)";
                    aiResponseArea.classList.remove("typing"); 
                } 
                else if (data.text) {
                    aiResponseArea.innerHTML += data.text.replace(/\n/g, '<br>');
                }
            };
            evtSource.onerror = (err) => {
                console.error("EventSource failed:", err);
                aiResponseArea.textContent = "AI ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸)";
                aiResponseArea.classList.remove("typing");
                evtSource.close();
                evtSource = null;
                aiButton.disabled = false;
                aiButton.textContent = "ğŸ¤– ë¶„ì„ ì¬ì‹œë„";
            };
        });

        // 6. í†µê³„(KPI) ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStats(stats, portfolio_history) {
            const portfolio = stats.portfolio;
            const benchmark = stats.benchmark;
            const formatCurrency = (val) => `â‚©${Math.round(val).toLocaleString()}`;
            const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
            const periodEl = document.getElementById('period-text');
            if (periodEl && portfolio_history && portfolio_history.length > 0) {
                periodEl.textContent = 
                    `í…ŒìŠ¤íŠ¸ ê¸°ê°„: ${portfolio_history[0].date} ~ ${portfolio_history[portfolio_history.length - 1].date}`;
            }
            document.getElementById('pf-value').textContent = formatCurrency(portfolio['Final Value']);
            document.getElementById('pf-cagr').textContent = formatPercent(portfolio.CAGR);
            document.getElementById('pf-mdd').textContent = formatPercent(portfolio.MDD);
            document.getElementById('bm-value').textContent = formatCurrency(benchmark['Final Value']);
            document.getElementById('bm-cagr').textContent = formatPercent(benchmark.CAGR);
            document.getElementById('bm-mdd').textContent = formatPercent(benchmark.MDD);
        }
        
        // 7. ë©”ì¸ ë¼ì¸ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (ìŒì˜ ì²˜ë¦¬ ì œê±°ë¨)
        function renderChart(portfolioData, benchmarkData) {
            const ctx = document.getElementById('backtestChart').getContext('2d');
            const labels = portfolioData.map(item => item.date);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤ (ì›”ê°„ ë¦¬ë°¸ëŸ°ì‹±)', data: portfolioData.map(item => item.value), borderColor: 'royalblue', borderWidth: 3, fill: false, pointRadius: 0 },
                        { label: 'KOSPI (Buy & Hold)', data: benchmarkData.map(item => item.value), borderColor: 'gray', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    hover: { mode: 'index', intersect: false },
                    plugins: { 
                        tooltip: { mode: 'index', intersect: false }
                        // Annotation í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ì œê±°ë¨
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'month', tooltipFormat: 'yyyy-MM-dd' } },
                        y: { ticks: { callback: (value) => value.toLocaleString() } }
                    }
                }
            });
        }

        // 8. â­ï¸ --- [ì‹ ê·œ] ë“œë¡­ë‹¤ìš´ ì„¤ì • í•¨ìˆ˜ --- â­ï¸
        function setupCrashDropdown(crashPeriods) {
            const selectElement = document.getElementById('crash-period-select');
            
            // 1. ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì±„ìš°ê¸°
            if (!crashPeriods || crashPeriods.length === 0) {
                selectElement.disabled = true;
                const option = document.createElement('option');
                option.textContent = "ë¶„ì„ ê°€ëŠ¥í•œ í•˜ë½ì¥ì´ ì—†ìŠµë‹ˆë‹¤.";
                selectElement.appendChild(option);
                return;
            }

            crashPeriods.forEach((period, index) => {
                const option = document.createElement('option');
                option.value = index; // â­ï¸ ì˜µì…˜ì˜ ê°’ìœ¼ë¡œ ë°ì´í„°ì˜ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©
                option.textContent = `${period.name} (${period.start_date} ~ ${period.end_date})`;
                selectElement.appendChild(option);
            });

            // 2. ë“œë¡­ë‹¤ìš´ì— 'change' ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            selectElement.addEventListener('change', (event) => {
                const selectedIndex = event.target.value; // ì„ íƒëœ <option>ì˜ value (ì¸ë±ìŠ¤)
                const selectedPeriodData = allCrashPeriodData[selectedIndex];
                
                // â­ï¸ ì„ íƒëœ ë°ì´í„°ë¡œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                renderSingleCrashChart(selectedPeriodData);
            });
        }

        // 9. â­ï¸ --- [ì‹ ê·œ] ë‹¨ì¼ í•˜ë½ì¥ ë°” ì°¨íŠ¸ ë Œë”ë§/ì—…ë°ì´íŠ¸ í•¨ìˆ˜ --- â­ï¸
        function renderSingleCrashChart(period) {
            if (!period) return; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ì§€
            
            const ctx = document.getElementById('singleCrashChartCanvas').getContext('2d');

            // 1. ì°¨íŠ¸ìš© ë°ì´í„° ì¤€ë¹„
            const pfReturn = (period.portfolio_return || 0) * 100;
            const bmReturn = (period.benchmark_return || 0) * 100;
            const chartTitle = `${period.name} (${period.start_date} ~ ${period.end_date})`;
            
            // 2. â­ï¸ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (singleCrashChartInstance) {
                // 2a. ì¡´ì¬í•˜ë©´: ë°ì´í„°ì™€ ì œëª©ë§Œ ì—…ë°ì´íŠ¸
                singleCrashChartInstance.data.datasets[0].data = [pfReturn, bmReturn];
                singleCrashChartInstance.options.plugins.title.text = chartTitle;
                singleCrashChartInstance.update();
            } else {
                // 2b. ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ (ìµœì´ˆ 1íšŒ): ìƒˆ ì°¨íŠ¸ ìƒì„±
                singleCrashChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤', 'KOSPI'],
                        datasets: [{
                            label: 'ìˆ˜ìµë¥  (%)',
                            data: [pfReturn, bmReturn],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)', // í¬íŠ¸í´ë¦¬ì˜¤ (íŒŒë‘)
                                'rgba(201, 203, 207, 0.7)'  // KOSPI (íšŒìƒ‰)
                            ],
                            borderColor: [
                                'rgb(54, 162, 235)',
                                'rgb(201, 203, 207)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: chartTitle, // â­ï¸ ë™ì  ì œëª©
                                font: { size: 14 }
                            },
                            legend: { display: false }, // ë²”ë¡€ ìˆ¨ê¸°ê¸°
                            tooltip: { // â­ï¸ íˆ´íŒ ì½œë°± (v3+ ë°©ì‹)
                                callbacks: {
                                    label: (tooltipItem) => {
                                        // tooltipItem.rawì—ì„œ ìˆ«ì ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                                        const value = (typeof tooltipItem.raw === 'number') ? tooltipItem.raw : 0;
                                        return `${value.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'ìˆ˜ìµë¥  (%)' },
                                ticks: {
                                    callback: (value) => `${value.toFixed(1)}%`
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>